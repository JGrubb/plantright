<?php

function plantright_flag($action, $flag, $content_id, $account) {
	if($action == 'flag' && $flag->name == 'nursery_flag') {
		$node = node_load($content_id);
		//dpm($node->field_surveying_user);
		$member = array();
		$member['uid'] = $account->uid;
		array_push($node->field_surveying_user, $member);
		//dpm($node->field_surveying_user);
		node_save($node);
	}
	if($action == 'unflag' && $flag->name == 'nursery_flag') {
	  $node = node_load($content_id);
	  $users = $node->field_surveying_user;
	  $node->field_surveying_user = removeElementWithValue($users, "uid", $account->uid);
	  node_save($node);
	}  
}

function removeElementWithValue($array, $key, $value){
  foreach($array as $subKey => $subArray){
    if($subArray[$key] == $value){
      unset($array[$subKey]);
    }
  }
  return $array;
}



function plantright_user($op, &$edit, &$account, $category = NULL) {
  if ($op == 'login') {
    //dpm($account);
    //dpm($edit);
  }
}

function plantright_nodeapi(&$node, $op) {
  //if ($node->type == 'retail_member') {
  //  dpm($node);
  //}
}

function _plantright_role_sender(&$form, &$form_state) {
  global $user;
  $node = node_load(array('uid' => $account->uid, 'type' => 'retail_member'));
  $rids = array_keys($user->roles);
  //If a manager and hasn't registered a store, redirect to node/add/business form
  if ($node->field_retailer[0]['nid'] == NULL) {
    if (in_array(7, $rids) || in_array(8, $rids)) {
      $form_state['redirect'] = 'node/add/business';
    }
  }
  //If an employee, handle that
  if (in_array(9, $rids) || in_array(10, $rids)) {
    // If verified, go to resources
    if (in_array(11, $rids)) {
      drupal_goto('partner-resources');
    } else {
      // If not verified, go to training
      drupal_goto('plantright-101-training');
    }
  }
}


function plantright_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_register') {
    $form['account']['mail']['#description'] = 'A valid e-mail address. All e-mails from the system will be sent to this address.<br />
      The e-mail address is not made public and your information will not be sold, or shared with others.';
    return $form;
  }
  if ($form_id == 'user_login' || $form_id == 'user_login_block') {
    $form['#action'] = NULL;
    $form['#submit'] = array('_plantright_role_sender');
  }
  if ($form_id == 'user_pass_reset') {
    $form['#redirect'] = 'user';
  }
  if ($form_id == 'node_form' && $form['type'] == 'retail_member') {
    $form['contact']['#prefix'] = '<div class="contact-info">';
    $form['contact']['#suffix'] = '</div>';
  } 
  //dpm($form);
}

